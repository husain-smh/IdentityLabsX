# GitHub Actions: Job Scheduler
# Triggers SOCAP worker endpoints every 15 minutes
# This replaces the local job-scheduler.ts cron

name: SOCAP Job Scheduler

on:
  schedule:
    # Runs every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub UI

env:
  API_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}

jobs:
  trigger-workers:
    name: Trigger SOCAP Workers
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Trigger Job Creation
        run: |
          echo "üöÄ Triggering job creation at $API_BASE_URL/api/socap/workers/trigger"
          
          # -L follows redirects (Vercel often returns 308 for trailing slash)
          RESPONSE=$(curl -sL -w "\n%{http_code}" -X POST \
            "$API_BASE_URL/api/socap/workers/trigger" \
            -H "Content-Type: application/json")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "‚ùå Request failed with status $HTTP_CODE"
            exit 1
          fi
          
          echo "‚úÖ Job creation triggered successfully"

      - name: Process Jobs
        run: |
          echo "‚öôÔ∏è Running job processor at $API_BASE_URL/api/socap/workers/run"
          
          # -L follows redirects (Vercel often returns 308 for trailing slash)
          RESPONSE=$(curl -sL -w "\n%{http_code}" -X POST \
            "$API_BASE_URL/api/socap/workers/run" \
            -H "Content-Type: application/json" \
            -d '{"maxJobs": 100, "concurrency": 5}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "‚ùå Request failed with status $HTTP_CODE"
            exit 1
          fi
          
          echo "‚úÖ Jobs processed successfully"
